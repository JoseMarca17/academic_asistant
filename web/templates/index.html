<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Academic Assistant Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body style="font-family: Arial, sans-serif; padding: 20px;">
    
    <div style="background: #f0f0f0; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
        <strong>Panel de AdministraciÃ³n:</strong>
        <button type="button" onclick="actualizarApuntes()">ğŸ”„ Procesar Mis Notas</button>
        <button type="button" onclick="limpiarChat()">ğŸ—‘ï¸ Resetear ConversaciÃ³n</button>
    </div>

    <h1>ğŸ§  Academic Assistant</h1>
    
    <form id="formBusqueda">
        <input type="text" id="inputPregunta" placeholder="Haz una pregunta o usa el micro..." style="width: 60%; padding: 10px;">
        <button type="submit" style="padding: 10px;">Enviar</button>
        <button type="button" id="btnDictar" style="padding: 10px;">ğŸ¤ Dictar</button>
    </form> 

    <div id="contenedorRespuesta" style="margin-top: 20px; min-height: 150px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #fff;"></div>
    
    <div style="margin-top: 20px; font-size: 0.9em; color: #555;">
        <strong>Fuentes:</strong>
        <ul id="fuentes"></ul>
    </div>

    <button type="button" id="btnSilenciarVoz" style="display:none; margin-top: 10px;">ğŸ”‡ Detener Voz</button>

    <script>
        const synth = window.speechSynthesis;
        const btnDictar = document.getElementById('btnDictar');
        const btnSilenciar = document.getElementById('btnSilenciarVoz');
        const inputPregunta = document.getElementById('inputPregunta');
        const form = document.getElementById('formBusqueda');
        const contenedor = document.getElementById('contenedorRespuesta');
        const listaFuentes = document.getElementById('fuentes');

        let chatHistory = [];
        let recognition;
        let isListening = false;
        let manualStop = false;

        async function actualizarApuntes() {
            if(!confirm("Esto limpiarÃ¡ y volverÃ¡ a indexar tus notas. Â¿Continuar?")) return;
            contenedor.innerHTML = "<em>Unificando y limpiando archivos...</em>";
            try {
                const resp = await fetch('/admin/unify', { method: 'POST' });
                const data = await resp.json();
                alert(data.message);
                contenedor.innerHTML = "";
            } catch (e) { alert("Error: " + e.message); }
        }

        function limpiarChat() {
            chatHistory = [];
            contenedor.innerHTML = "<em>Memoria del chat borrada.</em>";
            listaFuentes.innerHTML = "";
            synth.cancel();
        }

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = () => {
                isListening = true;
                manualStop = false;
                btnDictar.innerText = "ğŸ›‘ Detener y Enviar";
                btnDictar.style.backgroundColor = "#ff4d4d";
            };

            recognition.onresult = (event) => {
                let textoFinal = '';
                for (let i = 0; i < event.results.length; ++i) {
                    textoFinal += event.results[i][0].transcript;
                }
                inputPregunta.value = textoFinal;
            };

            recognition.onend = () => {
                if (isListening && !manualStop) {
                    recognition.start(); 
                } else {
                    btnDictar.innerText = "ğŸ¤ Dictar";
                    btnDictar.style.backgroundColor = "";
                }
            };

            btnDictar.onclick = () => {
                if (isListening) {
                    manualStop = true;
                    isListening = false;
                    recognition.stop();
                    if (inputPregunta.value.trim() !== "") form.dispatchEvent(new Event('submit'));
                } else {
                    synth.cancel();
                    inputPregunta.value = "";
                    recognition.start();
                }
            };
        }
        
        function hablar(texto) {
            const utterance = new SpeechSynthesisUtterance(texto.replace(/[#*`]/g, ''));
            utterance.lang = 'es-ES';
            utterance.onstart = () => btnSilenciar.style.display = 'block';
            utterance.onend = () => btnSilenciar.style.display = 'none';
            synth.speak(utterance);
        }

        btnSilenciar.onclick = () => { synth.cancel(); btnSilenciar.style.display = 'none'; };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const pregunta = inputPregunta.value;
            if (!pregunta) return;

            synth.cancel();
            contenedor.innerHTML = "<em>Generando respuesta...</em>";

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: pregunta, history: chatHistory }) 
                });
                
                const data = await response.json();
                if (response.ok) {
                    // Actualizar UI y Memoria
                    contenedor.innerHTML = marked.parse(data.answer); 
                    listaFuentes.innerHTML = data.sources.map(f => `<li>${f}</li>`).join('');
                    
                    chatHistory.push({ role: "user", content: pregunta });
                    chatHistory.push({ role: "model", content: data.answer });

                    hablar(data.answer);
                    inputPregunta.value = "";
                }
            } catch (error) { contenedor.innerHTML = "Error: " + error.message; }
        });
    </script>
</body>
</html>