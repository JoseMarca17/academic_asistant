<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Academic Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <h1>Academic Assistant</h1>
    
    <form id="formBusqueda">
        <input type="text" id="inputPregunta" placeholder="Realiza tu consulta o usa el micrÃ³fono" style="width: 70%; padding: 8px;">
        <button type="submit">Preguntar</button>
        <button type="button" id="btnDictar">ðŸŽ¤ Dictar Pregunta</button>
    </form> 

    <div id="contenedorRespuesta"></div>
    
    <div class="fuentes-lista" style="margin-top: 20px;">
        <strong>Fuentes consultadas:</strong>
        <ul id="fuentes"></ul>
    </div>

    <div style="margin-top: 10px;">
        <button type="button" id="btnSilenciarVoz" style="display:none;">Silenciar Asistente</button>
    </div>

    <script>
        const synth = window.speechSynthesis;
        const btnDictar = document.getElementById('btnDictar');
        const btnSilenciar = document.getElementById('btnSilenciarVoz');
        const inputPregunta = document.getElementById('inputPregunta');
        const form = document.getElementById('formBusqueda');

        let recognition;
        let isListening = false;
        let manualStop = false; 

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.lang = 'es-ES';
            recognition.continuous = true; 
            recognition.interimResults = true;

            recognition.onstart = () => {
                isListening = true;
                manualStop = false;
                btnDictar.innerText = "ðŸ›‘ Detener y Enviar";
                btnDictar.style.backgroundColor = "#ff4d4d";
                inputPregunta.placeholder = "Escuchando... no te detengas.";
            };

            recognition.onresult = (event) => {
                let textoFinal = '';
                for (let i = 0; i < event.results.length; ++i) {
                    textoFinal += event.results[i][0].transcript;
                }
                inputPregunta.value = textoFinal;
            };

            recognition.onend = () => {
                if (isListening && !manualStop) {
                    console.log("Reinicio automÃ¡tico del micro...");
                    recognition.start(); 
                } else {
                    detenerInterfaz();
                }
            };

            recognition.onerror = (event) => {
                console.error("Error micro:", event.error);
                if (event.error === 'no-speech') return; 
                detenerReconocimiento();
            };

            function detenerInterfaz() {
                isListening = false;
                btnDictar.innerText = "ðŸŽ¤ Dictar Pregunta";
                btnDictar.style.backgroundColor = "";
                inputPregunta.placeholder = "Realiza tu consulta";
            }

            function detenerReconocimiento() {
                manualStop = true;
                isListening = false;
                recognition.stop();
            }

            btnDictar.onclick = () => {
                if (isListening) {
                    detenerReconocimiento();
                    if (inputPregunta.value.trim() !== "") {
                        form.dispatchEvent(new Event('submit'));
                    }
                } else {
                    synth.cancel();
                    inputPregunta.value = "";
                    recognition.start();
                }
            };
        }
        
        function hablarAsistente(texto) {
            const textoLimpio = texto.replace(/[#*`]/g, '').replace(/\[.*?\]/g, '').replace(/```[\s\S]*?```/g, 'bloque de cÃ³digo');
            const utterance = new SpeechSynthesisUtterance(textoLimpio);
            utterance.lang = 'es-ES';
            utterance.onstart = () => btnSilenciar.style.display = 'inline';
            utterance.onend = () => btnSilenciar.style.display = 'none';
            synth.speak(utterance);
        }

        btnSilenciar.onclick = () => { synth.cancel(); btnSilenciar.style.display = 'none'; };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const textoUsuario = inputPregunta.value;
            const contenedor = document.getElementById('contenedorRespuesta');
            const listaFuentes = document.getElementById('fuentes');
            if (!textoUsuario) return;

            synth.cancel();
            contenedor.innerHTML = "<em>Procesando...</em>";

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: textoUsuario }) 
                });
                const data = await response.json();
                if (response.ok) {
                    contenedor.innerHTML = marked.parse(data.answer); 
                    listaFuentes.innerHTML = data.sources.map(f => `<li>${f}</li>`).join('');
                    hablarAsistente(data.answer);
                }
            } catch (error) {
                contenedor.innerHTML = "Error: " + error.message;
            }
        });
    </script>
</body>
</html>